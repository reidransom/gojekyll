#!/usr/bin/env bash

set -o errexit
set -o pipefail

BINARY=gojekyll
PACKAGE=github.com/osteele/gojekyll

if [ "$1" == "-v" ]; then
  set -x
  shift
fi

# -----------------------------------------------------------------------------
# Helper functions start with _ and aren't listed in this script's help menu.
# -----------------------------------------------------------------------------

function _get_version {
  git describe --tags --exact-match 2>/dev/null || git rev-parse --short HEAD 2>/dev/null
}

function _get_ldflags {
  VERSION=$(_get_version)
  BUILD_DATE=$(date +%FT%T%z)
  echo "-ldflags \"-X ${PACKAGE}/version.Version=${VERSION} -X ${PACKAGE}/version.BuildDate=${BUILD_DATE}\""
}

function test {
  go test ./...
}

function build {
  LDFLAGS=$(_get_ldflags)
  go build $LDFLAGS -o $BINARY $PACKAGE
}

function buildlinux {
  LDFLAGS=$(_get_ldflags)
  mkdir -p dist
  GOOS=linux GOARCH=amd64 go build $LDFLAGS -o dist/${BINARY}-linux-amd64 $PACKAGE
  GOOS=linux GOARCH=arm64 go build $LDFLAGS -o dist/${BINARY}-linux-arm64 $PACKAGE
}

function release {
  # Run lint and tests first
  lint
  test
  
  # Get the latest version tag
  LATEST_TAG=$(git tag --sort=-v:refname | head -1)
  
  if [ -z "$LATEST_TAG" ]; then
    echo "No existing tags found. Creating v0.0.1" >&2
    NEW_TAG="v0.0.1"
  else
    echo "Latest tag: $LATEST_TAG"
    
    # Parse version (assumes format like v0.5.0)
    if [[ $LATEST_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
      MAJOR="${BASH_REMATCH[1]}"
      MINOR="${BASH_REMATCH[2]}"
      PATCH="${BASH_REMATCH[3]}"
      
      # Bump patch version
      NEW_PATCH=$((PATCH + 1))
      NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
    else
      echo "Error: Could not parse version from tag: $LATEST_TAG" >&2
      exit 1
    fi
  fi
  
  echo "Creating new release: $NEW_TAG"
  
  # Create and push the new tag
  git tag "$NEW_TAG"
  git push origin "$NEW_TAG"
  
  echo "Released $NEW_TAG"
}

function lint {
  golangci-lint run
}

function clean {
  rm -f $BINARY
  rm -rf dist/
}

function install {
  LDFLAGS=$(_get_ldflags)
  go install $LDFLAGS $PACKAGE
}

function help {
  printf "%s <task> [args]\n\nTasks:\n" "${0}"

  compgen -A function | grep -v "^_" | cat -n

  printf "\nExtended help:\n  Each task has comments for general usage\n"
}

# This idea is heavily inspired by: https://github.com/adriancooney/Taskfile
TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
